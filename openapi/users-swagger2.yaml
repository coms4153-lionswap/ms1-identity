swagger: "2.0"
info:
  title: LionSwap Identity & Accounts API
  version: "0.1.0"
  description: Columbia LionMail-authenticated user identities
schemes:
  - http
basePath: /
consumes:
  - application/json
produces:
  - application/json
paths:
  /users:
    get:
      summary: List users
      tags: [users]
      responses:
        200:
          description: OK
          schema:
            type: array
            items:
              $ref: "#/definitions/User"
    post:
      summary: Create user
      tags: [users]
      parameters:
        - in: body
          name: body
          required: true
          schema:
            $ref: "#/definitions/UserCreate"
      responses:
        201:
          description: Created
          headers:
            Location:
              type: string
              description: URI of the created resource
          schema:
            $ref: "#/definitions/User"
  /users/{uni}:
    parameters:
      - name: uni
        in: path
        required: true
        type: string
    get:
      summary: Get user by uni
      tags: [ users ]
      parameters:
        - in: header
          name: If-None-Match
          type: string
          required: false
      responses:
        200:
          description: OK
          headers:
            ETag:
              type: string
          schema:
            $ref: "#/definitions/User"
        304:
          description: Not Modified
        404:
          description: Not Found
    put:
      summary: Replace user info with uni
      tags: [ users ]
      parameters:
        - in: header
          name: If-Match
          type: string
          required: true
        - in: body
          name: body
          required: true
          schema:
            $ref: "#/definitions/UserUpdate"
      responses:
        200:
          description: Updated
          headers:
            ETag:
              type: string
          schema:
            $ref: "#/definitions/User"
        412:
          description: ETag mismatch
        428:
          description: If-Match required
        404:
          description: Not Found

    delete:
      summary: Delete user with uni
      tags: [users]
      responses:
        200:
          description: Deleted
          schema:
            type: object
            properties:
              message:
                type: string
                example: 'Successfully deleted "ab1234" user'
        404: { description: Not Found }

  /users/{uni}/export:
    post:
      summary: Start user export (async)
      tags: [users]
      parameters:
        - name: uni
          in: path
          required: true
          type: string
      responses:
        202:
          description: Accepted
          schema:
            type: object
            properties:
              operation_id: { type: string }
              _links:
                $ref: "#/definitions/Links"

  /operations/{opId}:
    get:
      summary: Get async operation status
      tags: [users]
      parameters:
        - name: opId
          in: path
          required: true
          type: string
      responses:
        200:
          description: OK
          schema:
            type: object
            properties:
              status:
                type: string
                enum: [pending, running, succeeded, failed]
              result:
                type: object

definitions:
  User:
    type: object
    required: [uni, student_name, email]
    properties:
      uni: { type: string, example: "ab1234" }
      student_name: { type: string, example: "Sally Go" }
      major: { type: string, example: "CS" }
      email: { type: string, format: email, example: "sg####@columbia.edu" }
      phone: { type: string, nullable: true }
      created_at: { type: string, format: date-time }
      updated_at: { type: string, format: date-time }

  UserCreate:
    type: object
    required: [uni, student_name, email]
    properties:
      uni: { type: string }
      student_name: { type: string }
      major: { type: string }
      email: { type: string, format: email }
      phone: { type: string }

  UserUpdate:
    type: object
    properties:
      student_name: { type: string }
      major: { type: string }
      phone: { type: string }
  Link:
    type: object
    properties: { href: { type: string } }
    required: [href]
  Links:
    type: object
    additionalProperties:
      $ref: "#/definitions/Link"
